<!-- workflow-builder.component.html -->
<div class="workflow-page">

  <div class="mode-banner" *ngIf="workflowId">
    âœï¸ <strong>Cháº¿ Ä‘á»™ chá»‰nh sá»­a:</strong> Äang cáº­p nháº­t workflow <b>{{ workflowName }}</b>
  </div>

  <!-- Step header -->
  <div class="workflow-header-step">
    <div [class.active]="currentStep === 1" (click)="goToStep(1)">1ï¸âƒ£ Cáº¥u hÃ¬nh Trigger</div>
    <div [class.active]="currentStep === 2"
         [class.disabled]="currentStep === 1"
         (click)="goToStep(2)">2ï¸âƒ£ Thiáº¿t káº¿ Workflow</div>
  </div>


  <!-- ThÃ¢n mÃ n hÃ¬nh chia theo step -->
  <div class="workflow-body">
    <!-- Left Panel (chá»‰ hiá»‡n khi bÆ°á»›c 2) -->
    <div class="left-panel" *ngIf="currentStep === 2">
      <div>
        <h3>ğŸ§© ThÃªm Step</h3>
        <div class="step-buttons">
          <button (click)="addNode('send_email')">ğŸ“§ Gá»­i Email</button>
          <button (click)="addNode('delay')">â±ï¸ Äá»£i</button>
          <button (click)="addNode('add_tag')">ğŸ·ï¸ ThÃªm Tag</button>
          <button (click)="addNode('remove_tag')">âŒ XoÃ¡ Tag</button>
          <button (click)="addNode('add_to_sequence')">ğŸ“¥ Add to Sequence</button>
        </div>
      </div>
      <div class="action-buttons">
        <button (click)="createWorkflow()">âœ… Táº¡o Workflow</button>
        <button (click)="resetWorkflow()">ğŸ”„ Reset</button>
      </div>
    </div>

    <!-- Canvas chÃ­nh -->
    <div class="drawflow" #drawflowElement>
      <!-- Step 1: Trigger Panel -->
      <div class="trigger-panel" *ngIf="currentStep === 1">
        <h4>ğŸ¯ Cáº¥u hÃ¬nh Trigger START</h4>

        <label>TÃªn Workflow:</label>
        <input type="text" [(ngModel)]="workflowName" placeholder="Nháº­p tÃªn workflow..." />

        <label>Loáº¡i Ä‘iá»u kiá»‡n:</label>
        <select [(ngModel)]="newTrigger.conditionType">
          <option value="">-- Chá»n Ä‘iá»u kiá»‡n --</option>
          <option *ngFor="let t of triggerTypes" [value]="t.value">{{ t.label }}</option>
        </select>

        <div *ngIf="newTrigger.conditionType === 'TAG'">
          <label>Tag:</label>
          <select [value]="parsedTagId" (change)="handleTagChange($event)">
            <option *ngFor="let tag of availableTags" [value]="tag.id">{{ tag.name }}</option>
          </select>
        </div>

        <div *ngIf="newTrigger.conditionType === 'INACTIVE'">
          <label>Sá»‘ ngÃ y khÃ´ng hoáº¡t Ä‘á»™ng:</label>
          <input type="number" [value]="parsedDays" (input)="handleInactiveChange($event)" />
        </div>

        <div *ngIf="newTrigger.conditionType === 'INTERACTION'">
          <label>HÃ nh Ä‘á»™ng:</label>
          <select [value]="parsedAction" (change)="handleInteractionChange($event)">
            <option value="OPEN">Má»Ÿ Email</option>
            <option value="CLICK">Click Link</option>
          </select>
        </div>

        <div *ngIf="newTrigger.conditionType === 'SUBSCRIBED_BEFORE'">
          <label>NgÃ y Ä‘Äƒng kÃ½ trÆ°á»›c:</label>
          <input type="date" [value]="parsedDate" (change)="handleDateChange($event)" />
        </div>

        <label>Logic:</label>
        <select [(ngModel)]="newTrigger.logicOperator">
          <option value="AND">AND</option>
          <option value="OR">OR</option>
        </select>

        <button (click)="addOrUpdateTrigger()">
          {{ editIndex !== null ? 'âœï¸ Cáº­p nháº­t' : 'â• ThÃªm Ä‘iá»u kiá»‡n' }}
        </button>

        <!-- âœ… Preview trigger hiá»ƒn thá»‹ rÃµ rÃ ng -->
        <div class="trigger-preview" *ngIf="triggerConditions.length">
          <div *ngFor="let trig of triggerConditions; let i = index" class="trigger-item">
            <span class="type">{{ trig.conditionType }}</span>
            <span class="logic">({{ trig.logicOperator }})</span>
            <span class="data">{{ getTriggerLabel(trig) }}</span>
            <button (click)="editTrigger(i)">âœï¸</button>
            <button (click)="removeTrigger(i)">âŒ</button>
          </div>
        </div>

        <div class="bottom-action">
          <button (click)="nextStep()">âœ… Tiáº¿p tá»¥c</button>
        </div>

      </div>
    </div>
  </div>
</div>
